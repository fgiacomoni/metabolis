---
title: "Metabolomics data analysis of the *sacurine* cohorte"
author: "Etienne A. Thévenot"
date: "`r doc_date()`"
package: "`r pkg_ver('metabolis')`"

vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: "metabolis.bib"
output:
  BiocStyle::html_document:
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: false
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width = 8,
                      fig.height = 8,
                      fig.path = 'figures/sacurine/')
```

# Introduction

To characterize the physiological variations of the human urine metabolome with age, body mass index (BMI), and gender, samples from a cohort of adult volunteers from the Saclay research institute (hence the “sac[lay]urine” name) have been analyzed by LC–HRMS
[[@thevenot_analysis_2015]](https://doi.org/10.1021/acs.jproteome.5b00354).

In this study conducted by the [MetaboHUB](http://www.metabohub.fr/home.html) French Infrastructure for Metabolomics, urine samples from 184 volunteers were analyzed by reversed-phase (C18) ultrahigh performance liquid chromatography (UPLC) coupled to high-resolution mass spectrometry (LTQ-Orbitrap). Raw data are publicly available on the MetaboLights repository ([MTBLS404](https://www.ebi.ac.uk/metabolights/MTBLS404)).

This vignette describes the statistical analysis of the data set from the negative ionization mode (113 identified metabolites at MSI levels 1 or 2):

* correction of signal drift (loess model built on QC pools) and batch effects (two batches)

* variable filtering (QC coefficent of variation < 30%)

* normalization by the sample osmolality

* log10 transformation, sample filtering (Hotelling, decile and missing pvalues > 0.001) resulting in the HU_096 sample being discarded

* univariate hypothesis testing of significant variations with age, BMI, or between genders (FDR < 0.05)

* PCA exploration of the data set; [**ropls**](https://doi.org/10.18129/B9.bioc.ropls) Bioconductor package [[@thevenot_analysis_2015]](https://doi.org/10.1021/acs.jproteome.5b00354)

* OPLS(-DA) modeling of age, BMI and gender; [**ropls**](https://doi.org/10.18129/B9.bioc.ropls) Bioconductor package [[@thevenot_analysis_2015]](https://doi.org/10.1021/acs.jproteome.5b00354)

* selection of the features which significantly contributes to the discrimination between gender with PLS-DA, Random Forest, or Support Vector Machines classifiers; [**biosigner**](https://doi.org/10.18129/B9.bioc.biosigner) Bioconductor package [[@rinaudo_biosigner:_2016]](https://doi.org/10.3389/fmolb.2016.00026)

![Methods from the **metabolis**, **ropls**, and **biosigner** packages used for the analysis of the *sacurine* dataset](figures/permanent/metabolis_methods.png)

A Galaxy version of this analysis is available [W4M00001 'Sacurine-statistics'](https://doi.org/10.15454/1.4811121736910142E12) on the [Workflow4metabolomics.org](https://workflow4metabolomics.org) online infrastructure [[@guitton_create_2017]](https://doi.org/10.1016/j.biocel.2017.07.002)




# Hands-on

Loading the *metabolis* package

```{r package}
suppressMessages(library(metabolis))
```

## **metRead**: Reading the data

The **metRead** function reads the data sets and builds the *ExpressionSet* object. For additional information about *ExpressionSet* class, see the "An introduction to Biobase and ExpressionSets" documentation from the [Biobase](https://doi.org/doi:10.18129/B9.bioc.Biobase) package.

![3 table format used as input](figures/permanent/metabolis_3tables-format.png)

```{r metRead}
sacSet <- metabolis::metRead(system.file("extdata/sacurine",
                                         package = "metabolis"))
```

## **metView**: Looking at the data

```{r metView}
sacSet <- metabolis::metView(sacSet)
```

## Post-processing

### **metCorrect**: Correcting signal drift and batch effect

```{r metCorrect}
sacSet <- metabolis::metCorrect(sacSet)
```

### Variable filtering

features with QC coefficent of variation > 30%

* using **metView** to compute the 'pool_CV' metric
```{r metView-variable filtering}
sacSet <- metabolis::metView(sacSet)
```

* discarding features with 'pool_CV' > 0.3
```{r discarding pool_CV > 0.3}
sacSet <- sacSet[Biobase::fData(sacSet)[, "pool_CV"] <= 0.3, ]
```

* discarding the 'pool' observations
```{r discarding pools}
sacSet <- sacSet[, Biobase::pData(sacSet)[, "sampleType"] != "pool"]
print(sacSet)
```


### Normalizing

osmolality

```{r normalizing osmolality}
Biobase::exprs(sacSet) <- sweep(Biobase::exprs(sacSet),
                                2,
                                Biobase::pData(sacSet)[, "osmolality"],
                                "/")
```

### **metTransform**: Transforming the data intensities

```{r metTransform}
sacSet <- metabolis::metTransform(sacSet, "log10")

```

### Sample filtering

Hotelling, decile and missing p-values > 0.001

```{r sample filtering}
sacSet <- metabolis::metView(sacSet)
sacSet <- sacSet[, Biobase::pData(sacSet)[, "hotel_pval"] >= 0.001 &
                   Biobase::pData(sacSet)[, "miss_pval"] >= 0.001 &
                   Biobase::pData(sacSet)[, "deci_pval"] >= 0.001]
```

Final visual check of the data before performing the statistics

```{r final check}
metabolis::metView(sacSet)
```


## **metTest**: Univariate hypothesis testing

```{r metTest}
sacSet <- metabolis::metTest(sacSet,
                             factor = "gender",
                             testC = "limma",
                             adjustC = "BH")

```

## Unsupervised analysis

### PCA modeling

[**ropls**](https://doi.org/10.18129/B9.bioc.ropls) Bioconductor package

[[@thevenot_analysis_2015]](https://doi.org/10.1021/acs.jproteome.5b00354)

```{r PCA}
suppressMessages(library(ropls))
sacPca <- ropls::opls(sacSet)
plot(sacPca,
     parAsColFcVn = Biobase::pData(sacSet)[, "gender"],
                                   typeVc = "x-score")
plot(sacPca,
     parAsColFcVn = Biobase::pData(sacSet)[, "age"],
                                   typeVc = "x-score")
plot(sacPca,
     parAsColFcVn = Biobase::pData(sacSet)[, "bmi"],
                                   typeVc = "x-score")
```

```{r pca getEset}
sacSet <- ropls::getEset(sacPca)
```

### **metHeatmap**: hierarchical clustering

```{r heatmap}
sacSet <- metabolis::metHeatmap(sacSet, clustVi = c(5, 3))
```

## Supervised modeling

### PLS modeling

[**ropls**](https://doi.org/10.18129/B9.bioc.ropls) Bioconductor package

[[@thevenot_analysis_2015]](https://doi.org/10.1021/acs.jproteome.5b00354)

```{r plsda}
sacPlsda <- ropls::opls(sacSet, "gender")
```

```{r plsda getEset}
sacSet <- ropls::getEset(sacPlsda)
```

### Feature selection

[**biosigner**](https://doi.org/10.18129/B9.bioc.biosigner) Bioconductor package

[[@rinaudo_biosigner:_2016]](https://doi.org/10.3389/fmolb.2016.00026)

```{r biosigner}
suppressMessages(library(biosigner))
set.seed(123)
sacSign <- biosigner::biosign(sacSet, "gender")
set.seed(NULL)
sacSet <- biosigner::getEset(sacSign)
```

## **metWrite**: Exporting the results

```{r metWrite, eval = FALSE}
metabolis::metWrite(sacSet, dirC = getwd())
```


# References